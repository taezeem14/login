<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>HackoAI ‚Ä¢ Chat Interface.</title>
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="site.webmanifest">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://js.puter.com/v2/"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css">

<style>
@import url('https://fonts.googleapis.com/css2?family=Smooch+Sans:wght@100..900&display=swap');
*{box-sizing:border-box;margin:0;padding:0}

:root{
  --bg:#f4f4f5; --panel:#fff; --chat:#f9fafb;
  --border:#e5e7eb; --user:#2563eb; --bot:#e5e7eb;
  --text:#111827; --muted:#6b7280;
  --link:#2563eb; --sidebar:#f9fafb;
}

pre::-webkit-scrollbar {height: 6px;}
pre::-webkit-scrollbar-track {background: var(--chat);border-radius: 3px;}
pre::-webkit-scrollbar-thumb {background: #2563eb;border-radius: 3px;}
button.toggle:hover {background: rgba(239,68,68,.15);border-color: #ef4444;}

body.dark{
  --bg:#020617; --panel:#0f172a; --chat:#1e293b;
  --border:#1f2937; --user:#2563eb; --bot:#0f172a;
  --text:#e5e7eb; --muted:#94a3b8;
  --link:#22c55e; --sidebar:#0a0f1e;
}

body{
  font-family: "Smooch Sans", sans-serif;
  font-size: 25px;
  background:var(--bg);
  display:flex;justify-content:center;align-items:center;
  height:100vh;color:var(--text);
  overflow: hidden;
}

.container{
  width:100%;max-width:1100px;height:90vh;
  display:flex;gap:0;
  box-shadow:0 20px 40px rgba(0,0,0,.3);
  border-radius:14px;overflow:hidden;
}

/* ===== SIDEBAR ===== */
.sidebar{
  width:260px;
  background:var(--sidebar);
  border-right:1px solid var(--border);
  display:flex;
  flex-direction:column;
  position: relative;
  transition: transform 0.3s ease, width 0.3s ease;
}


.sidebar-header{
  padding:14px 16px;
  border-bottom:1px solid var(--border);
  font-weight:600;display:flex;
  justify-content:space-between;align-items:center;
  flex-wrap:wrap;gap:8px;
}

.sidebar-controls{
  display:flex;gap:6px;width:100%;
}

.new-chat-btn, .import-btn, .export-btn{
  background:#2563eb;border:none;color:#fff;
  padding:6px 10px;border-radius:6px;
  cursor:pointer;font-size:12px;font-weight:600;
  transition:background 0.2s;flex:1;
}

.new-chat-btn:hover, .import-btn:hover, .export-btn:hover{background:#1d4ed8;}
.export-btn{background:#10b981;}
.export-btn:hover{background:#059669;}

.search-box{
  width:100%;padding:8px;
  background:var(--chat);border:1px solid var(--border);
  border-radius:6px;color:var(--text);
  outline:none;font-size:13px;
}

.history-list{
  flex:1;overflow-y:auto;padding:8px;
  display:flex;flex-direction:column;gap:4px;
}

.history-group{
  margin-bottom:12px;
}

.history-group-title{
  font-size:11px;
  color:var(--muted);
  padding:4px 8px;
  font-weight:600;
  text-transform:uppercase;
  letter-spacing:0.5px;
}

.history-item{
  padding:10px 12px;border-radius:8px;
  cursor:pointer;font-size:14px;
  border:1px solid transparent;
  display:flex;justify-content:space-between;
  align-items:center;transition:all 0.2s;
  position:relative;
}

.history-item:hover{
  background:var(--chat);border-color:var(--border);
}

.history-item.active{
  background:var(--user);color:#fff;
}

.history-item .title{
  flex:1;overflow:hidden;
  text-overflow:ellipsis;white-space:nowrap;
  cursor:text;
}

.title-input{
  flex:1;
  background:transparent;
  border:1px solid var(--border);
  color:inherit;
  padding:2px 6px;
  border-radius:4px;
  font-size:14px;
  outline:none;
}

.history-item-actions{
  display:flex;gap:4px;opacity:0;
  transition:opacity 0.2s;
}

.history-item:hover .history-item-actions{opacity:1;}

.pin-chat, .delete-chat{
  background:none;border:none;
  color:inherit;cursor:pointer;
  font-size:14px;padding:2px 4px;
}

.history-item.pinned .pin-chat{opacity:1;color:#fbbf24;}

.history-list::-webkit-scrollbar {width: 6px;}
.history-list::-webkit-scrollbar-track {background: var(--sidebar);}
.history-list::-webkit-scrollbar-thumb {background: var(--user);border-radius: 8px;}

/* ===== MAIN APP ===== */
.app{
  flex:1;
  background:var(--panel);
  display:flex;flex-direction:column;
  overflow: hidden;
}

header{
  padding:14px 16px;
  border-bottom:1px solid var(--border);
  display:flex;justify-content:space-between;align-items:center;
  font-weight:600;
  flex-shrink: 0;
}

.title-edit{
  background:transparent;
  border:1px solid var(--border);
  color:var(--text);
  padding:4px 8px;
  border-radius:6px;
  font-size:14px;
  font-weight:600;
  outline:none;
}

.controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}

.menu-btn{
  background:transparent;border:1px solid var(--border);
  color:var(--text);padding:6px 10px;border-radius:8px;
  cursor:pointer;display:none;
}

select,button.toggle{
  background:transparent;border:1px solid var(--border);
  color:var(--text);padding:6px 10px;border-radius:8px;
  cursor:pointer;
}

#chat{
  flex:1;padding:16px;overflow-y:auto;
  display:flex;flex-direction:column;gap:16px;
  background:var(--chat);position:relative;
}

.msg{
  max-width:85%;padding:12px 14px;
  border-radius:12px;line-height:1.5;
  opacity:0;animation:fadeIn .25s forwards;
  position:relative;
  word-wrap: break-word;
  overflow-wrap: anywhere;
}

.msg:hover .msg-actions{opacity:1;}

.msg-actions{
  position:absolute;top:6px;right:6px;
  display:flex;gap:4px;opacity:0;
  transition:opacity 0.2s;
}

.msg-btn{
  background:rgba(0,0,0,0.6);
  border:none;color:#fff;
  padding:4px 8px;border-radius:4px;
  cursor:pointer;font-size:10px;
}

.user{align-self:flex-end;background:var(--user);color:#fff}
.bot{align-self:flex-start;background:var(--bot);color:var(--text)}

.msg a{color: var(--link);text-decoration: underline;}
.msg a:hover{color: #4ade80;}

.timestamp{font-size:10px;color:var(--muted);margin-top:6px;}

pre{
  position:relative;background:#020617;
  border-radius:10px;padding:12px;
  margin-top:8px;overflow-x:auto;
  max-height:400px;
  transition:max-height 0.3s;
}

pre.collapsed{max-height:80px;overflow:hidden;}

pre code{font-size:13px}

.copy-btn, .collapse-btn{
  position:absolute;top:6px;
  background:#2563eb;border:none;color:#fff;
  font-size:11px;padding:4px 8px;
  border-radius:6px;cursor:pointer;
}

.copy-btn{right:6px;}
.collapse-btn{right:60px;}

.scroll-bottom{
  position:fixed;bottom:100px;right:calc(50% - 300px);
  background:#2563eb;border:none;color:#fff;
  padding:10px 14px;border-radius:50%;
  cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,0.3);
  opacity:0;pointer-events:none;
  transition:opacity 0.3s;
  z-index:5;
}

.scroll-bottom.visible{opacity:1;pointer-events:all;}

footer{
  display:flex;gap:8px;padding:12px;
  border-top:1px solid var(--border);
  background:var(--panel);
  flex-shrink: 0;
}

.input-container{
  flex:1;display:flex;flex-direction:column;
}

input{
  width:100%;padding:12px;border-radius:8px;
  border:1px solid var(--border);
  background:transparent;color:var(--text);
  outline:none;
  min-width: 0;
  box-sizing: border-box;
}

.char-counter{
  font-size:10px;color:var(--muted);
  padding:2px 8px;text-align:right;
}

button.send{
  padding:0 18px;border-radius:8px;
  border:none;background:#2563eb;
  color:#fff;font-weight:600;cursor:pointer;
}

.spinner{
  width:18px;height:18px;
  border:3px solid var(--border);
  border-top:3px solid #2563eb;
  border-radius:50%;
  animation:spin 1s linear infinite;
}

@keyframes spin{to{transform:rotate(360deg)}}
@keyframes fadeIn{to{opacity:1;}}

#chat::-webkit-scrollbar {width: 8px;}
#chat::-webkit-scrollbar-track {background: var(--panel);border-radius: 8px;}
#chat::-webkit-scrollbar-thumb {background-color: var(--user);border-radius: 8px;border: 2px solid var(--panel);}
body.dark #chat::-webkit-scrollbar-thumb {background-color: #2563eb;border: 2px solid #0f172a;}

.msg ul, .msg ol {padding-left: 20px;margin: 8px 0;}
.msg li {margin-bottom: 4px;}
  
.sidebar.is-hidden {
  transform: translateX(-100%);
}

@media (min-width: 769px) {
  .sidebar.is-hidden {
    width: 0;
    min-width: 0;
    padding: 0;
    border-right: none;
    overflow: hidden;
  }
}

.menu-close-btn {
  display: none;
  position: absolute;
  top: 11px;
  right: 12px;
  margin: 0;
  background: #2563eb;
  color: #fff;
  border: none;
  padding: 6px 8px;
  border-radius: 8px;
  font-size: 14px;
  cursor: pointer;
  z-index: 20;
}

.bot img.ai-img {
  max-width: 100%;
  border-radius: 12px;
  margin-top: 8px;
  display: block;
}

/* ===== THEMED SELECT ===== */
.controls select {
  background: linear-gradient(
    180deg,
    rgba(255,255,255,0.04),
    rgba(0,0,0,0.05)
  ), var(--panel);
  
  box-shadow: inset 0 0 0 1px rgba(255,255,255,0.03);
  color: var(--text);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 7px 36px 7px 12px;

  font-size: 13px;
  font-weight: 600;
  cursor: pointer;

  outline: none;
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;

  transition:
    border-color 0.2s,
    box-shadow 0.2s,
    background 0.2s;
}

.controls select:hover {
  border-color: var(--user);
}

.controls select:focus {
  border-color: var(--user);
  box-shadow: 0 0 0 2px rgba(37,99,235,0.35);
}

.controls select option {
  background: var(--panel);
  color: var(--text);
}

.select-wrap {
  position: relative;
  display: inline-flex;
  align-items: center;
}

.select-wrap::after {
  content: "‚ñæ";
  position: absolute;
  right: 12px;
  pointer-events: none;
  font-size: 12px;
  color: var(--muted);
}

/* ===== MOBILE OPTIMIZED ===== */
@media(max-width:768px){
  body {
    padding: 0;
    margin: 0;
    font-size: 16px;
  }
  
  .container {
    width: 100vw;
    height: 100vh;
    max-width: 100%;
    border-radius: 0;
    box-shadow: none;
  }
  
  .sidebar{
    position: fixed;
    top: 0;
    left: 0;
    height: 100vh;
    width: 75vw;
    max-width: 300px;
    z-index: 999;
    box-shadow: 2px 0 12px rgba(0,0,0,0.5);
  }
  
  .menu-btn, .menu-close-btn { 
    display: block !important; 
  }
  
  .scroll-bottom { 
    right: 16px;
    bottom: 90px;
    padding: 8px 12px;
  }
  
  .app {
    flex-direction: column;
    width: 100%;
    height: 100vh;
  }
  
  header {
    padding: 10px 12px;
    font-size: 13px;
    gap: 6px;
  }
  
  #headerTitle {
    font-size: 15px;
    max-width: 100px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  
  .controls {
    gap: 4px;
  }
  
  .controls button.toggle {
    padding: 5px 7px;
    font-size: 16px;
  }
  
  .controls select {
    padding: 5px 20px 5px 8px;
    font-size: 11px;
  }
  
  .select-wrap::after {
    right: 6px;
    font-size: 10px;
  }
  
  #chat {
    padding: 10px;
    gap: 12px;
  }
  
  .msg {
    max-width: 92%;
    font-size: 15px;
    padding: 10px 12px;
  }
  
  .msg pre {
    font-size: 12px;
    max-height: 250px;
  }
  
  .msg pre code {
    font-size: 11px;
  }
  
  footer {
    padding: 8px;
    gap: 6px;
  }
  
  input {
    padding: 10px;
    font-size: 15px;
  }
  
  button.send {
    padding: 0 16px;
    font-size: 15px;
  }
  
  .char-counter {
    font-size: 9px;
    padding: 2px 4px;
  }
  
  /* Sidebar mobile adjustments */
  .sidebar-header {
    padding: 12px;
  }
  
  .search-box {
    font-size: 14px;
    padding: 8px;
  }
  
  .history-item {
    font-size: 13px;
    padding: 9px 10px;
  }
  
  .new-chat-btn, .import-btn, .export-btn {
    font-size: 11px;
    padding: 6px 8px;
  }
}

/* Extra small screens */
@media(max-width:375px){
  body {
    font-size: 15px;
  }
  
  #headerTitle {
    max-width: 80px;
    font-size: 14px;
  }
  
  .controls button.toggle {
    padding: 4px 6px;
    font-size: 14px;
  }
  
  .msg {
    font-size: 14px;
    padding: 9px 11px;
  }
  
  input {
    font-size: 14px;
    padding: 9px;
  }
  
  button.send {
    padding: 0 14px;
    font-size: 14px;
  }
}
</style>
</head>

<body class="dark">

<div class="container">
  <!-- PRE-POPUP -->
<div id="prePopup" style="
  position:fixed;
  top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.8);
  display:flex;justify-content:center;align-items:center;
  z-index:9999;flex-direction:column;color:#fff;text-align:center;
  font-family: 'Smooch Sans', sans-serif;
">
  <h2 style="margin-bottom:12px;">Welcome to HackoAI üöÄ</h2>
  <p style="margin-bottom:24px;">You need a Puter account to continue and unlock full features!</p>
  <button id="goToPuter" style="
    background:#2563eb;color:#fff;padding:12px 24px;border:none;
    border-radius:8px;font-weight:600;font-size:16px;cursor:pointer;
  ">Create / Upgrade Account</button>
</div>

  <!-- SIDEBAR -->
  <div class="sidebar" id="sidebar">
    <button class="menu-close-btn" onclick="toggleSidebar()">‚úï</button>
    <div class="sidebar-header">
      <input type="text" class="search-box" id="searchBox" placeholder="üîç Search chats...">
      <div class="sidebar-controls">
        <button class="new-chat-btn" onclick="newChat()">+ New</button>
        <button class="export-btn" onclick="exportAll()">üì•</button>
        <button class="import-btn" onclick="importAll()">üì§</button>
      </div>
    </div>
    <div class="history-list" id="historyList"></div>
  </div>

  <!-- MAIN APP -->
  <div class="app">
    <header>
      <div style="display:flex;align-items:center;gap:10px">
        <button class="menu-btn" onclick="toggleSidebar()">‚ò∞</button>
        <span id="headerTitle" ondblclick="editTitle()">HackoAI</span>
      </div>
      <div class="controls">
        <button class="toggle" onclick="exportChat()">üíæ</button>
        <button class="toggle" onclick="copyAll()">üìã</button>
        <button class="toggle" onclick="clearChat()">üóëÔ∏è</button>
        <button class="toggle" onclick="toggleTheme()">üåó</button>
        <button class="toggle" onclick="clearPuter()">üîÅ Credits</button>
        <div class="select-wrap">
        <select id="imageModel">
        <option value="google/imagen-4.0-ultra">Imagen 4 Ultra</option>
        <option value="google/imagen-4.0-fast">Imagen 4 Fast</option>
        <option value="gemini-3-pro-image-preview">Nano Banana (Gemini Image)</option>
        </select>
      </div>
      </div>
    </header>

    <div id="chat"></div>
    <button class="scroll-bottom" id="scrollBottom" onclick="scrollToBottom()">‚Üì</button>

    <footer>
      <div class="input-container">
        <input id="input" placeholder="Type a message‚Ä¶ (Ctrl+B for new chat)" />
        <div class="char-counter" id="charCounter">0 chars</div>
      </div>
      <button class="send" onclick="send()">Send</button>
    </footer>
  </div>
</div>

<input type="file" id="importFile" accept=".json" style="display:none" onchange="handleImport(event)">

<script>
async function clearPuter() {
  // wipe storage
  localStorage.clear();
  localStorage.clear();

  // wipe cache storage
  if ("caches" in window) {
    const keys = await caches.keys();
    for (const k of keys) await caches.delete(k);
  }

  // wipe indexedDB
  if (indexedDB.databases) {
    const dbs = await indexedDB.databases();
    for (const db of dbs) {
      indexedDB.deleteDatabase(db.name);
    }
  }

  alert("Don't Get Greedy , Now Enjoy üíÄ");
  location.reload();
}
  
  const script = document.createElement("script");
script.src = "https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/highlight.min.js";
script.onload = () => {
  console.log("Highlight.js loaded!");
  // initialize syntax highlighting if needed
  document.querySelectorAll("pre code").forEach(block => hljs.highlightElement(block));
};
document.head.appendChild(script);


const chat=document.getElementById("chat");
const input=document.getElementById("input");
const sidebar=document.getElementById("sidebar");
const historyList=document.getElementById("historyList");
const searchBox=document.getElementById("searchBox");
const scrollBottom=document.getElementById("scrollBottom");
const charCounter=document.getElementById("charCounter");
const headerTitle=document.getElementById("headerTitle");
const PREPOPUP_KEY = "hackoai_prepopup_clicked";

let lastUserPrompt = null;
let isGenerating = false;

function retryLast() {
  if (!lastUserPrompt || isGenerating) return;

  const session = getCurrentSession();

  // remove last bot message from session
  for (let i = session.messages.length - 1; i >= 0; i--) {
    if (session.messages[i].role === "bot") {
      session.messages.splice(i, 1);
      break;
    }
  }

  // re-render chat cleanly
  chat.innerHTML = "";
  session.messages.forEach(m => render(m.role, m.content, false));

  saveSessions();

  input.value = lastUserPrompt;
  send();
}

  if (lastBot) lastBot.remove();

  const session = getCurrentSession();
  for (let i = session.messages.length - 1; i >= 0; i--) {
    if (session.messages[i].role === "bot") {
      session.messages.splice(i, 1);
      break;
    }
  }

  saveSessions();
  input.value = lastUserPrompt;
  send();
}

function editMessage(oldContent) {
  input.value = oldContent;
  input.focus();
}

/* ===== SESSION MANAGEMENT ===== */
/* ===== STORAGE HELPERS ===== */
const SESSIONS_KEY = "hackoai_sessions";
const CURRENT_KEY = "hackoai_current";

let sessions = loadSessions();
let currentId = localStorage.getItem(CURRENT_KEY) || null;

function loadSessions() {
  try {
    return JSON.parse(localStorage.getItem(SESSIONS_KEY)) || {};
  } catch {
    localStorage.removeItem(SESSIONS_KEY);
    return {};
  }
}

function saveSessions() {
  // always make sure current session exists
  if (!sessions[currentId]) {
    const ids = Object.keys(sessions);
    currentId = ids.length ? ids[0] : Date.now().toString();
    if (!sessions[currentId]) {
      sessions[currentId] = {
        id: currentId,
        title: "New Chat",
        messages: [],
        timestamp: Date.now(),
        pinned: false,
        autoTitled: false
      };
    }
  }

  localStorage.setItem(SESSIONS_KEY, JSON.stringify(sessions));
  localStorage.setItem(CURRENT_KEY, currentId);
  renderHistory();
  updateHeaderTitle();
}

function getCurrentSession() {
  if (!sessions[currentId]) saveSessions(); // safety net
  return sessions[currentId];
}

function saveMessage(role, content) {
  const session = getCurrentSession();
  session.messages.push({ role, content });
  session.timestamp = Date.now(); // update timestamp for sorting
  saveSessions();
}

/* ===== IMPORT FIX ===== */
function handleImport(e) {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = (ev) => {
    try {
      const imported = JSON.parse(ev.target.result);
      if (confirm("Import chats? This will merge with existing chats.")) {
        // dedupe IDs to prevent overwriting
        for (const id in imported) {
          if (!sessions[id]) sessions[id] = imported[id];
          else {
            const newId = Date.now().toString() + Math.floor(Math.random() * 1000);
            imported[id].id = newId;
            sessions[newId] = imported[id];
          }
        }
        saveSessions();
        alert("‚úÖ Chats imported successfully!");
      }
    } catch {
      alert("‚ùå Invalid file format!");
    }
  };
  reader.readAsText(file);
}




function updateHeaderTitle(){
  const existingTitle=document.getElementById("headerTitle");
  if(existingTitle){
    existingTitle.textContent=getCurrentSession().title;
  }
}

function editTitle(){
  const session=getCurrentSession();
  const currentTitle=session.title;
  
  const input=document.createElement("input");
  input.type="text";
  input.className="title-edit";
  input.value=currentTitle;
  
  headerTitle.replaceWith(input);
  input.focus();
  input.select();
  
  const save=()=>{
    const newTitle=input.value.trim();
    if(newTitle){
      session.title=newTitle;
      saveSessions();
    }
    
    const span=document.createElement("span");
    span.id="headerTitle";
    span.textContent=session.title;
    span.ondblclick=editTitle;
    input.replaceWith(span);
  };
  
  input.onblur=save;
  input.onkeydown=(e)=>{
    if(e.key==="Enter"){
      e.preventDefault();
      save();
    }
    if(e.key==="Escape"){
      input.value=currentTitle;
      save();
    }
  };
}

/* ===== TIMESTAMP GROUPING ===== */
function groupByTime(sessions){
  const now=Date.now();
  const day=86400000;
  
  const groups={
    pinned:[],
    today:[],
    yesterday:[],
    week:[],
    older:[]
  };
  
  sessions.forEach(s=>{
    if(s.pinned){
      groups.pinned.push(s);
      return;
    }
    const diff=now-s.timestamp;
    if(diff<day) groups.today.push(s);
    else if(diff<day*2) groups.yesterday.push(s);
    else if(diff<day*7) groups.week.push(s);
    else groups.older.push(s);
  });
  
  return groups;
}

/* ===== HISTORY SIDEBAR ===== */
function renderHistory(){
  const query=searchBox.value.toLowerCase().trim();
  let filtered=Object.values(sessions);
  
  if(query){
    filtered=filtered.filter(s=>
      s.title.toLowerCase().includes(query)||
      s.messages.some(m =>
  typeof m.content === "string" &&
  m.content.toLowerCase().includes(query)
)
    );
  }
  
  const sorted=filtered.sort((a,b)=>b.timestamp-a.timestamp);
  const groups=groupByTime(sorted);
  
  historyList.innerHTML="";
  
  const renderGroup=(title,items)=>{
    if(items.length===0) return;
    
    const groupDiv=document.createElement("div");
    groupDiv.className="history-group";
    
    const titleDiv=document.createElement("div");
    titleDiv.className="history-group-title";
    titleDiv.textContent=title;
    groupDiv.appendChild(titleDiv);
    
    items.forEach(s=>{
      const div=document.createElement("div");
      div.className="history-item"+(s.id===currentId?" active":"")+(s.pinned?" pinned":"");
      
      const title=document.createElement("span");
      title.className="title";
      title.textContent=s.title;
      title.ondblclick=(e)=>{
        e.stopPropagation();
        editChatTitle(s.id,title,div);
      };
      
      const actions=document.createElement("div");
      actions.className="history-item-actions";
      
      const pin=document.createElement("button");
      pin.className="pin-chat";
      pin.textContent=s.pinned?"‚≠ê":"‚òÜ";
      pin.onclick=(e)=>{
        e.stopPropagation();
        togglePin(s.id);
      };
      
      const del=document.createElement("button");
      del.className="delete-chat";
      del.textContent="‚úï";
      del.onclick=(e)=>{
        e.stopPropagation();
        deleteChat(s.id);
      };
      
      actions.appendChild(pin);
      actions.appendChild(del);
      
      div.appendChild(title);
      div.appendChild(actions);
      div.onclick=()=>loadChat(s.id);
      
      groupDiv.appendChild(div);
    });
    
    historyList.appendChild(groupDiv);
  };
  
  renderGroup("üìå PINNED",groups.pinned);
  renderGroup("TODAY",groups.today);
  renderGroup("YESTERDAY",groups.yesterday);
  renderGroup("THIS WEEK",groups.week);
  renderGroup("OLDER",groups.older);
}

function togglePin(id){
  sessions[id].pinned=!sessions[id].pinned;
  saveSessions();
}

function editChatTitle(id,titleSpan,parentDiv){
  const session=sessions[id];
  const oldTitle=session.title;
  
  const input=document.createElement("input");
  input.type="text";
  input.className="title-input";
  input.value=oldTitle;
  
  // Stop propagation to prevent chat switching
  input.onclick=(e)=>e.stopPropagation();
  
  titleSpan.replaceWith(input);
  input.focus();
  input.select();
  
  const save=()=>{
    const newTitle=input.value.trim();
    if(newTitle&&newTitle!==oldTitle){
      session.title=newTitle;
      if(id===currentId){
        updateHeaderTitle();
      }
      saveSessions();
    }
    
    const newSpan=document.createElement("span");
    newSpan.className="title";
    newSpan.textContent=session.title;
    newSpan.ondblclick=(e)=>{
      e.stopPropagation();
      editChatTitle(id,newSpan,parentDiv);
    };
    input.replaceWith(newSpan);
  };
  
  input.onblur=save;
  input.onkeydown=(e)=>{
    e.stopPropagation(); // Prevent any parent handlers
    if(e.key==="Enter"){
      e.preventDefault();
      input.blur();
    }
    if(e.key==="Escape"){
      input.value=oldTitle;
      input.blur();
    }
  };
}

function newChat(){
  currentId=Date.now().toString();
  sessions[currentId]={
    id:currentId,
    title:"New Chat",
    messages:[],
    timestamp:Date.now(),
    pinned:false,
    autoTitled: false   // üî• REQUIRED
  };
  saveSessions();
  chat.innerHTML="";
}

function loadChat(id){
  currentId=id;
  localStorage.setItem(CURRENT_KEY,currentId);
  chat.innerHTML="";
  getCurrentSession().messages.forEach(m=>render(m.role,m.content,false));
  renderHistory();
  scrollToBottom();
}

function deleteChat(id){
  if(!confirm("Delete this chat? üíÄ")) return;
  delete sessions[id];
  
  if(id===currentId){
    const remaining=Object.keys(sessions);
    if(remaining.length>0){
      loadChat(remaining[0]);
    }else{
      newChat();
    }
  }
  saveSessions();
}

function clearChat(){
  if(!confirm("Clear current chat? This cannot be undone üíÄ")) return;
  const session = getCurrentSession();
  session.messages = [];
  session.title = "New Chat";
  session.autoTitled = false; // üî• RESET
  saveSessions();
  chat.innerHTML = "";
  render("bot","**Chat cleared. Fresh slate üòé‚ú®**", false);
}

function toggleSidebar(){
  sidebar.classList.toggle("is-hidden");
}
  if (window.innerWidth <= 768) {
  sidebar.classList.add("is-hidden");
}

/* ===== EXPORT/IMPORT ===== */
function exportChat(){
  const session=getCurrentSession();
  let text=`# ${session.title}\n\n`;
  session.messages.forEach(m => {
  if (typeof m.content === "string") {
    text += `**${m.role.toUpperCase()}:**\n${m.content}\n\n`;
  } else {
    text += `**${m.role.toUpperCase()}:**\n[${m.content.type.toUpperCase()}]\n\n`;
  }
});
  
  const blob=new Blob([text],{type:"text/markdown"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download=`${session.title.replace(/[^a-z0-9]/gi,'_')}.md`;
  a.click();
  URL.revokeObjectURL(url);
}

function copyAll(){
  const session=getCurrentSession();
  let text="";
  session.messages.forEach(m=>{
    text+=`${m.role.toUpperCase()}: ${m.content}\n\n`;
  });
  
  navigator.clipboard.writeText(text);
  alert("üìã Entire chat copied to clipboard!");
}

function exportAll(){
  const data=JSON.stringify(sessions,null,2);
  const blob=new Blob([data],{type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download=`hackoai_backup_${Date.now()}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

function importAll(){
  document.getElementById("importFile").click();
}
/* ===== SCROLL TRACKING ===== */
chat.addEventListener("scroll",()=>{
  const atBottom=chat.scrollHeight-chat.scrollTop-chat.clientHeight<50;
  scrollBottom.classList.toggle("visible",!atBottom);
});

function scrollToBottom(){
  chat.scrollTo({top:chat.scrollHeight,behavior:"smooth"});
}

/* ===== CHAR COUNTER ===== */
input.addEventListener("input",()=>{
  const len=input.value.length;
  charCounter.textContent=`${len} chars`;
  charCounter.style.color=len>4000?"#ef4444":len>2000?"#f59e0b":"var(--muted)";
});

/* ===== SEARCH ===== */
searchBox.addEventListener("input",renderHistory);

/* ===== KEYBOARD SHORTCUTS ===== */
document.addEventListener("keydown",(e)=>{
  if(e.ctrlKey&&e.key==="b"){
    e.preventDefault();
    newChat();
  }
  if(e.ctrlKey&&e.key==="k"){
    e.preventDefault();
    searchBox.focus();
  }
});

/* ===== UTILS ===== */
  function timestampEl() {
  const t = document.createElement("div");
  t.className = "timestamp";
  t.textContent = time();
  return t;
}

function time(){
  const d=new Date();
  return d.getHours().toString().padStart(2,'0')+":"+
         d.getMinutes().toString().padStart(2,'0');
}

function preprocess(text){
  return text
    .replace(/~~(.*?)~~/g, "$1")
    .replace(/<\/?(s|del|strike)>/gi, "");
}

/* ===== RENDER ===== */
function render(role, content, saveIt=true){
  const d = document.createElement("div");
  d.className = "msg " + role;

  if (typeof content === "object" && content.type === "image") {
    const img = document.createElement("img");
    img.src = content.src;
    img.className = "ai-img";
    d.appendChild(img);
  } else if (typeof content === "object" && content.type === "video") {
    const video = document.createElement("video");
    video.src = content.src;
    video.controls = true;
    video.autoplay = true;
    video.loop = true;
    video.style.maxWidth = "100%";
    video.style.borderRadius = "12px";
    d.appendChild(video);
  } else if (typeof content === "string") {
    d.innerHTML = marked.parse(preprocess(content));
  }
  // Add message actions for user messages
  if(role==="user"){
    const actions=document.createElement("div");
    actions.className="msg-actions";
    
    const editBtn=document.createElement("button");
    editBtn.className="msg-btn";
    editBtn.textContent="‚úèÔ∏è Edit";
    editBtn.onclick=()=>editMessage(content);
    
    actions.appendChild(editBtn);
    d.appendChild(actions);
  }

  // Add retry button for bot messages
if (role === "bot") {
  const actions = document.createElement("div");
  actions.className = "msg-actions";

  const retryBtn = document.createElement("button");
  retryBtn.className = "msg-btn";
  retryBtn.textContent = "üîÑ Retry";
  retryBtn.title = "Regenerate response";

  retryBtn.onclick = () => retryLast();

  actions.appendChild(retryBtn);
  d.appendChild(actions);
}
  
  d.querySelectorAll("pre code").forEach(block=>{
    hljs.highlightElement(block);

    const pre=block.parentElement;
    
    const collapseBtn=document.createElement("button");
    collapseBtn.className="collapse-btn";
    collapseBtn.textContent="‚ñº";
    collapseBtn.onclick=()=>{
      pre.classList.toggle("collapsed");
      collapseBtn.textContent=pre.classList.contains("collapsed")?"‚ñ∂":"‚ñº";
    };
    
    const btn=document.createElement("button");
    btn.className="copy-btn";
    btn.textContent="COPY";
    btn.onclick=()=>{
      navigator.clipboard.writeText(block.textContent);
      btn.textContent="COPIED";
      setTimeout(()=>btn.textContent="COPY",1000);
    };
    
    pre.appendChild(collapseBtn);
    pre.appendChild(btn);
  });

  const t=document.createElement("div");
  t.className="timestamp";
  t.textContent=time();
  d.appendChild(t);

  chat.appendChild(d);
  chat.scrollTop=chat.scrollHeight;

  if(saveIt){
    saveMessage(role,content);
  }
  return d;
}
  
/* ===== TYPEWRITER ===== */
// GLOBAL: typewriter bot streamer
async function streamBotInChunks(fullText, chunkSize = 50) {
  const d = document.createElement("div");
  d.className = "msg bot";
  chat.appendChild(d);

  let renderedText = "";
  const session = getCurrentSession();
  saveMessage("bot", "");
  const botIndex = getCurrentSession().messages.length - 1;

  for (let i = 0; i < fullText.length; i += chunkSize) {
    const chunk = fullText.slice(i, i + chunkSize);
    renderedText += chunk;
    d.innerHTML = marked.parse(preprocess(renderedText));
    chat.scrollTop = chat.scrollHeight;

    // live update
    session.messages[botIndex].content = renderedText;
    localStorage.setItem(SESSIONS_KEY, JSON.stringify(sessions));

    await new Promise(r => setTimeout(r, 15));
  }
}
  const prePopup = document.getElementById("prePopup");
const goToPuter = document.getElementById("goToPuter");
  
  // check popup state on load
if (localStorage.getItem(PREPOPUP_KEY) === "true") {
  prePopup.style.display = "none";
}
  
goToPuter.addEventListener("click", () => {
  // remember that user clicked it
  localStorage.setItem(PREPOPUP_KEY, "true");

  // hide popup
  prePopup.style.display = "none";

  // enable interactions if needed
  chat.style.pointerEvents = "auto";

  // redirect
  window.open("https://puter.com/dashboard", "_blank");
});

  
// AUTO Chat titling
  async function generateTitle(userPrompt, botReply) {
  const res = await fetch("https://hackoai-worker.tariqmtaezeem.workers.dev", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      text: `
Create a short chat title (3‚Äì6 words).
No quotes. No emojis.

User: ${userPrompt}
Assistant: ${botReply}
      `.trim()
    })
  });

  const data = await res.json();

  return (
    data.choices?.[0]?.message?.content
      ?.replace(/["\n]/g, "")
      ?.slice(0, 40)
  ) || "New Chat";
}

  
// SEND function for DeepSeek
async function send() {
  if (isGenerating) return;

  let prompt = input.value.trim();
  if (!prompt) return;

  isGenerating = true;
  lastUserPrompt = prompt;

  const firstUserPrompt = prompt;
  const session = getCurrentSession();
  const shouldAutoTitle =
  !session.autoTitled &&
  session.messages.length === 0 &&
  !prompt.startsWith("/img") &&
  !prompt.startsWith("/vid");
  if (!prompt) return;

  input.value = "";
  charCounter.textContent = "0 chars";
  
  const cmd = prompt.trim().toLowerCase();
  const isImage = prompt.startsWith("/img ");
  const isVideo = prompt.startsWith("/vid ");

  if (isImage || isVideo) prompt = prompt.slice(5);

  render("user", prompt);
  const loading = render("bot", "<div class='spinner'></div>", false);

  try {
/* ================= IMAGE ================= */
if (isImage) {
  const model = document.getElementById("imageModel").value;

  puter.ai.txt2img(prompt, {
    model,
    disable_safety_checker: true
  })
  .then(img => {
    loading.remove();

    const div = document.createElement("div");
    div.className = "msg bot";

    img.classList.add("ai-img");

    img.onload = () => {
      const canvas = document.createElement("canvas");
      canvas.width = img.naturalWidth;
      canvas.height = img.naturalHeight;
      canvas.getContext("2d").drawImage(img, 0, 0);
      const base64 = canvas.toDataURL();
      saveMessage("bot", { type: "image", src: base64 });
    };

    div.appendChild(img);
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  })
  .catch(err => {
    loading.remove();
    isGenerating = false;
    console.error(err);
    render("bot", "**Image gen failed üíÄ**");
  });
}
    /* ================= VIDEO ================= */
    else if (isVideo) {
      const video = await puter.ai.txt2vid(prompt, {
        model: "sora-2",
        seconds: 8,
        size: "1280x720"
      });

      loading.remove();

      video.controls = true;
      video.autoplay = true;
      video.loop = true;
      video.style.maxWidth = "100%";
      video.style.borderRadius = "12px";

      const div = document.createElement("div");
div.className = "msg bot";

div.appendChild(video);
chat.appendChild(div);
chat.scrollTop = chat.scrollHeight;

// Save video as object instead of string
saveMessage("bot", { type: "video", src: video.src });

    }

    /* ================= TEXT ================= */
    else {
      const res = await fetch("https://hackoai-worker.tariqmtaezeem.workers.dev", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ text: prompt })
  });
      const text = await res.text();

let data;
try {
  data = JSON.parse(text);
} catch {
  console.error("Non-JSON response:", text);
  throw new Error("Server returned invalid response");
}

      loading.remove();

      const answer =
        data.choices?.[0]?.message?.content ||
        "üíÄ Empty response from DeepSeek";
      
      await streamBotInChunks(answer);
      isGenerating = false;
      if (shouldAutoTitle) {
  const title = await generateTitle(firstUserPrompt, answer);
  session.title = title;
  session.autoTitled = true;
  saveSessions();
}

updateHeaderTitle();

    }
  } catch (err) {
    loading.remove();
    isGenerating = false;
    console.error(err);
    render("bot", "**Network error üíÄ**");
  }
}


function toggleTheme() {
  document.body.classList.toggle("dark");
}

input.addEventListener("keydown", (e) => {
  if (e.key === "Enter") send();
});

// Load initial session
getCurrentSession().messages.forEach(m=>render(m.role,m.content,false));
renderHistory();
updateHeaderTitle();

</script>
</body>
</html>




